name: Validate Gemfury Packages

on:
  workflow_dispatch:
  schedule:
    # Run every Monday at 12:00 PM (EET/EEST, UTC+2/UTC+3)
    # Using UTC+2 (EET) = 10:00 UTC
    - cron: '0 10 * * 1'
  push:
    branches:
      # - main
      - feat/validate-gemfury-packages

# Environment variables
env: #TODO - make this dynamic
  DEB_VERSION: "21.0.2"
  RPM_VERSION: "21.0.1-1"  # Full package version including release number for RPM
  APK_VERSION: "21.0.1"

jobs:
  test-deb:
    name: Test DEB Package (apt)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build and test DEB package
        working-directory: test-gemfury-packages
        run: |
          echo "=== Testing DEB (Ubuntu/Debian - apt) ==="
          echo "Target version: ${DEB_VERSION}"
          
          # Build the Docker image
          docker build -f Dockerfile.test-deb \
            --build-arg XIOND_VERSION=${DEB_VERSION} \
            -t xiond-test-deb:${DEB_VERSION} .
          
          # Get installed version
          INSTALLED_VERSION=$(docker run --rm xiond-test-deb:${DEB_VERSION} xiond version 2>/dev/null)
          INSTALLED_VERSION_CLEAN=${INSTALLED_VERSION#v}
          
          # Verify version matches
          if [ "$INSTALLED_VERSION_CLEAN" = "$DEB_VERSION" ]; then
            echo "âœ“ DEB installation successful - Version: $INSTALLED_VERSION"
            echo "Installed version matches expected: $DEB_VERSION"
          else
            echo "âœ— DEB version mismatch - Expected: $DEB_VERSION, Got: $INSTALLED_VERSION_CLEAN"
            exit 1
          fi
          
          # Show detailed version info
          echo ""
          echo "Detailed version information:"
          docker run --rm xiond-test-deb:${DEB_VERSION} xiond version --long

  test-rpm:
    name: Test RPM Package (yum)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build and test RPM package
        working-directory: test-gemfury-packages
        run: |
          echo "=== Testing RPM (Rocky Linux - yum) ==="
          echo "Target package version: ${RPM_VERSION}"
          
          # Extract base version for comparison (xiond version outputs base version without release number)
          RPM_BASE_VERSION=$(echo $RPM_VERSION | cut -d'-' -f1)
          echo "Expected xiond binary version: ${RPM_BASE_VERSION}"
          
          # Build the Docker image (full version control - pass complete version)
          docker build -f Dockerfile.test-rpm \
            --build-arg XIOND_VERSION=${RPM_VERSION} \
            -t xiond-test-rpm:${RPM_VERSION} .
          
          # Get installed version (xiond version command outputs base version without release number)
          INSTALLED_VERSION=$(docker run --rm xiond-test-rpm:${RPM_VERSION} xiond version 2>/dev/null)
          INSTALLED_VERSION_CLEAN=${INSTALLED_VERSION#v}
          
          # Verify version matches (xiond version output is base version, not package version)
          if [ "$INSTALLED_VERSION_CLEAN" = "$RPM_BASE_VERSION" ]; then
            echo "âœ“ RPM installation successful - Package: ${RPM_VERSION}, Binary: $INSTALLED_VERSION"
            echo "Installed version matches expected: $RPM_BASE_VERSION"
          else
            echo "âœ— RPM version mismatch - Expected: $RPM_BASE_VERSION, Got: $INSTALLED_VERSION_CLEAN"
            exit 1
          fi
          
          # Show detailed version info
          echo ""
          echo "Detailed version information:"
          docker run --rm xiond-test-rpm:${RPM_VERSION} xiond version --long

  test-apk:
    name: Test APK Package (apk)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build and test APK package
        working-directory: test-gemfury-packages
        run: |
          echo "=== Testing APK (Alpine Linux - apk) ==="
          echo "Target version: ${APK_VERSION}"
          
          # Build the Docker image
          docker build -f Dockerfile.test-apk \
            --build-arg XIOND_VERSION=${APK_VERSION} \
            -t xiond-test-apk:${APK_VERSION} .
          
          # Get installed version
          INSTALLED_VERSION=$(docker run --rm xiond-test-apk:${APK_VERSION} xiond version 2>/dev/null)
          INSTALLED_VERSION_CLEAN=${INSTALLED_VERSION#v}
          
          # Verify version matches
          if [ "$INSTALLED_VERSION_CLEAN" = "$APK_VERSION" ]; then
            echo "âœ“ APK installation successful - Version: $INSTALLED_VERSION"
            echo "Installed version matches expected: $APK_VERSION"
          else
            echo "âœ— APK version mismatch - Expected: $APK_VERSION, Got: $INSTALLED_VERSION_CLEAN"
            exit 1
          fi
          
          # Show detailed version info
          echo ""
          echo "Detailed version information:"
          docker run --rm xiond-test-apk:${APK_VERSION} xiond version --long

  notify-slack:
    name: Notify Slack on Failure
    runs-on: ubuntu-latest
    needs: [test-deb, test-rpm, test-apk]
    if: always()
    steps:
      - name: Check if any test failed
        id: check-failures
        continue-on-error: true
        run: |
          DEB_RESULT="${{ needs.test-deb.result }}"
          RPM_RESULT="${{ needs.test-rpm.result }}"
          APK_RESULT="${{ needs.test-apk.result }}"
          
          echo "DEB result: $DEB_RESULT"
          echo "RPM result: $RPM_RESULT"
          echo "APK result: $APK_RESULT"
          
          if [ "$DEB_RESULT" != "success" ] || [ "$RPM_RESULT" != "success" ] || [ "$APK_RESULT" != "success" ]; then
            echo "has_failures=true" >> $GITHUB_OUTPUT
            echo "Found failures - will send notification"
          else
            echo "has_failures=false" >> $GITHUB_OUTPUT
            echo "All tests passed - no notification needed"
          fi

      - name: Send Slack notification on failure
        if: steps.check-failures.outputs.has_failures == 'true'
        continue-on-error: true
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.NOTIFY_DEVOPS_SLACK_APP_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.DEVOPS_NOTIFICATIONS_SLACK_CHANNEL_ID }}
            text: "ðŸš¨ Gemfury Package Validation Failed: 
            <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>"
          errors: warn
          retries: 0
        

